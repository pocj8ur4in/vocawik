name: backend-cd
run-name: "backend-cd"

on:
  workflow_run:
    workflows: [ "backend-ci" ]
    types: [ completed ]
    branches: [ master ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGE_NAME }}
  DOCKER_CACHE_SCOPE: vocawik-docker-cache

permissions:
  contents: read

concurrency:
  group: cd-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  backend-cd:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tags
        id: tags
        shell: bash
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          if [ "$BRANCH" = "master" ]; then
            {
              echo "tags<<EOF"
              echo "${{ env.DOCKER_IMAGE }}:${SHA}"
              echo "${{ env.DOCKER_IMAGE }}:latest"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "tags<<EOF"
              echo "${{ env.DOCKER_IMAGE }}:dev-${SHA}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha,scope=${{ env.DOCKER_CACHE_SCOPE }}
          cache-to: type=gha,scope=${{ env.DOCKER_CACHE_SCOPE }},mode=max
